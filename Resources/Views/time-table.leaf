<html>
<head>
    <title>Concord Business Services Time Billing System</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="./css/jquery-ui-1.9.0.custom.min.css" />
    <link rel="stylesheet" _href="./css/jquery.dataTables.css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="./css/concordtb.css" />
    <script language="javascript" type="text/javascript"  src="https://code.jquery.com/jquery-3.4.1.min.js" _src="https://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script language="javascript" type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" _src="https://code.jquery.com/ui/1.9.0/jquery-ui.min.js"></script>
    <script language="javascript" type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" _src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
       <script language="javascript" type="text/javascript" src="./js/jquery.dataTables.columnFilter.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <style>
        #main_table{width:95%;}
        #timeTotal{font-weight:bold !important; padding-right:1em; !important}
        .dur, #timeTotal {text-align:right;}
        body {font-size:75%; font-family:Verdana, Arial, Sans-Serif;}
        .spanDeleteConfirmLabel {font-weight: bold; width: 8em;}

    </style>

</head>
<body class="mainbox" >

    <script type="text/javascript">
            
        myVars = {};
        myVars.initialLoad = true;
        myVars.rowToDelete = null;
        
        myVars.reAdd = function() {
            var sum = 0.0;
            $('.dur:visible').each(function(index,element) {
                $(element).text(parseFloat($(element).text()).toFixed(2));
                sum += parseFloat($(element).text());
            });
            $('#timeTotal').text(sum.toFixed(2));
            return this;
        }
        
        myVars.saveFilterToSession = function() {
            if (! myVars.initialLoad){
                $.ajax({
                    url: 'ajax/savesession',
                    type: 'post',
                    data: {
                        sesContract : $('#cellContractFilter select option:selected').text(),
                        sesProject : $('#cellProjectFilter select option:selected').text(),
                        sesDateTo : $('#cellDateFilter input:eq(1)').val(),
                        sesDateFrom : $('#cellDateFilter input:eq(0)').val(),
                        sesDurTo : $('#cellDurFilter input:eq(1)').val(),
                        sesDurFrom : $('#cellDurFilter input:eq(0)').val(),
                        sesNote : $('#cellNoteFilter input').val(),
                        sortCol : $.fn.dataTable.Api( '#main_table' ).context[0].aLastSort[0].col,
                        sortDir : $.fn.dataTable.Api( '#main_table' ).context[0].aLastSort[0].dir
                    },
                    success: function(data, status) {
                        if(data == "ok") {

                        }
                        else {
                            console.log("Error response received:");
                            console.log(data);
                            alert("Error updating session.  Your change was not saved.");
                        }
                    },
                    error: function(xhr, desc, err) {
                        console.log(xhr);
                        console.log("Details: " + desc + "\nError:" + err);
                        alert("Error updating session.  Your change was not saved.");
                    }
                });  // end ajax call
            }
        }
            
        $(document).ready(function() {
            $("#main_table").dataTable( {
                "iDisplayLength" : 50,
                "order" : [[#(filter.sortColumn), "#(filter.sortDirection)"]],
                "aaSorting" : [[#(filter.sortColumn), "#(filter.sortDirection)"]],
                "fnDrawCallback": function() {
                    myVars.reAdd();
                    myVars.saveFilterToSession();
                },
                "aoColumns" : [null,
                               null,
                               null,
                               null,
                               null,
                               null,
                               {'bSortable' : false},
                               {'bSortable' : false}],
                "filter" : function (value, index){
                    
                    
                }
            })
                .columnFilter({
                    "aoColumns" : [ null,
                                   {type: "select", values: #raw(cOpts), selected : '#(filter.contract)' },
                                   {type: "select", values: #raw(pOpts), selected : '#(filter.project)' },
                                   {type: "date-range", min: '#(filter.dateFrom)', max : '#(filter.dateTo)' },
                                   {type: "number-range", min: '#(filter.durationFrom)', max : '#(filter.durationTo)'},
                                   {type: "text", bRegex: true, val : '#(filter.noteFilter)'},
                                   null,
                                   null]
                });

            $('#row#(highlightRow)').ready(function() {
                var theRow = $('#row#(highlightRow) td');
                var origColor = $('#row#(highlightRow) td').css("backgroundColor");
                $(theRow).css({backgroundColor: '#ffff00'});
                setTimeout(function() {
                    $(theRow).animate({backgroundColor: origColor}, 3000);
                }, 500);
            });
            
            $('#cellDateFilter input:eq(0)').val('#(filter.dateFrom)');
            $('#cellDateFilter input:eq(1)').val('#(filter.dateTo)');
            $('#cellDurFilter input:eq(0)').val(#(filter.durationFrom));
            $('#cellDurFilter input:eq(1)').val(#(filter.durationTo));
            $('#cellNoteFilter input').val('#(filter.noteFilter)');
            $('#cellNoteFilter').append(' (Regex)');
            
            
            
            $('#dlgConfirmDelete').dialog({
                autoOpen: false,
               // position: {my: "left-400", at: "right", of: '#group-3'},
                title: 'Confirmation',
                width: 515,
                modal : true,
                open: function(){
                    var row = myVars.rowToDelete
                    var id = $("#main_table tbody tr td").filter(function() {
                        return $(this).text() == row;
                    });
                    $("#spanConfirmID").text(id.text());
                    var contract = id.next();
                    $("#spanConfirmContract").text(contract.text());
                    var project = contract.next();
                    $("#spanConfirmProject").text(project.text());
                    var date = project.next();
                    $("#spanConfirmDate").text(date.text());
                    var duration = date.next();
                    $("#spanConfirmDuration").text(duration.text());
                    var notes = duration.next()
                    $("#spanConfirmNotes").text(notes.text());
                    $("#btnCancelDelete").focus();
                }
            });
            
            $("#btnConfirmDelete").button().click(function(){
                $.ajax({
                    url: "ajax/deleteTimeRecord",
                    dataType:"json",
                    async: false,
                    data: {timeId: myVars.rowToDelete},
                    type: "post",
                    success: function(data, textStatus ){
                        location.reload(true);
                    },
                    fail: function(xhr, textStatus, errorThrown){
                       alert('The request to delete');
                    }
                })
            });
            
            $("#btnCancelDelete").button().click(function(){
                $('#dlgConfirmDelete').dialog('close');
            });
            
  
            myVars.initialLoad = false;
        });
        
            
        
        
        


    </script>
    
    <h1>#(who)</h1>
    <table id="main_table"><thead>
    <tr><th>ID</th><th>Contract</th><th>Project</th><th>Date</th><th>Duration</th><th>Notes</th><th>&nbsp;</th><th>&nbsp;</th></tr>
    </thead><tbody>
    
    
    #for(row in entries) {
        <tr id="row#(row.TimeID)">
            <td>#(row.TimeID)
            </td><td>#(row.Description)
            </td><td>#if(row.ProjectNumber) { #(row.ProjectNumber) - } #(row.ProjectDescription)
                #if(row.PreDeliveryFlag) { <img src="./images/preDeliv.png" title="Pre-delivery: early concept or design work" alt="pre-deliv" style="height: 13px;"> }
                #if(row.UseOTRate) { <img src="./images/ot.png" title="Night, weekend, or overtime rate" alt="ot rate" style="height: 13px;"> }
                #if(row.ExportStatus) { <img src="./images/exported.png" title="Information has been exported" alt="exported" style="height: 13px;"> }
            </td><td>#date(row.WorkDate, "MM/dd/yyyy")
            </td><td class="dur">#(row.Duration)
            </td><td>#(row.Notes)
            </td><td><a href=TBAddEdit?timeId=#(row.TimeID)&projectId=#(row.ProjectID)><img src=images/edit-ben.png style=border-style:hidden></a>
            </td><td><a onclick="myVars.rowToDelete = #(row.TimeID); $('#dlgConfirmDelete').dialog('open');"><img src=images/delete-ben.png style=border-style:hidden></a>
            </td>
        </tr>
    }
    
    </tbody>
    <tfoot><tr>
       <th>Filter Results:</th>
       <th id="cellContractFilter">&nbsp;</th>
       <th id="cellProjectFilter">&nbsp;</th>
       <th id="cellDateFilter">&nbsp;</th>
       <th id="cellDurFilter">&nbsp;</th>
       <th id="cellNoteFilter"></th>
       <th>&nbsp;</th><th>&nbsp;</th>
    </tr><tr>
    <th>Total:</th><th>&nbsp;</th><th>&nbsp;</th><th>&nbsp;</th><th id="timeTotal">&nbsp;</th><th>&nbsp;</th><th>&nbsp;</th><th>&nbsp;</th></tr>
    </tfoot></table>'
    
    <div id="dlgConfirmDelete">
        <h3> Are you sure you want to delete this record?</h3>
        <table>
        <tr><td class="spanDeleteConfirmLabel">TimeID:</td><td id="spanConfirmID"></td></tr>
        <tr><td class="spanDeleteConfirmLabel">Contract:</td><td id="spanConfirmContract"></td></tr>
        <tr><td class="spanDeleteConfirmLabel">Project:</td><td id="spanConfirmProject"></td></tr>
        <tr><td class="spanDeleteConfirmLabel">Date:</td><td id="spanConfirmDate"></td></tr>
        <tr><td class="spanDeleteConfirmLabel">Duration:</td><td id="spanConfirmDuration"></td></tr>
        <tr><td class="spanDeleteConfirmLabel">Note:</td><td id="spanConfirmNote"></td></tr>
        </table>
        <button id="btnConfirmDelete">Delete</button>
        <button id="btnCancelDelete">Never Mind - Keep This</button>
    </div>
 
</body>
</html>

